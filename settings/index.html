<html>
<head>

<style>
	table#systemEventLog th, table#systemEventLog td { font-size: 14px; text-align: left; padding-right: 10px; }
	table#systemEventLog tr { font-size: 14px; }
	button.benext { margin-right: 10px; }
</style>
</head>
<body>
	<h2 data-i18n="settings.title"></h2>
    <p style="display:block" data-i18n="settings.description"></p>
	
	<fieldset>
		<legend data-i18n="settings.users.title"></legend>
        <table id="systemUserLog">
			<thead>
				<tr>
					<th data-i18n="settings.users.table.userId"></th>
					<th data-i18n="settings.users.table.userName"></th>
					<th data-i18n="settings.users.table.tags"></th>
					<th data-i18n="settings.users.table.status"></th>
				</tr>
			</thead>
			<tbody id="systemUserLogBody">
			</tbody>
		</table>
    </fieldset>
	
	<button class="left benext" style="display:block" onclick="addUser()" data-i18n="settings.buttons.addUser"></button>
	<button class="left benext" style="display:block" onclick="removeUser()" data-i18n="settings.buttons.removeUser"></button>
	<button class="left benext" style="display:block" onclick="save()" data-i18n="settings.buttons.saveSettings" ></button>
	
	<br /><br />
	
	<fieldset>
		<legend data-i18n="settings.systemEventLog.title"></legend>
        <table id="systemEventLog">
			<thead>
				<tr>
					<th data-i18n="settings.systemEventLog.table.datetime"></th>
					<th data-i18n="settings.systemEventLog.table.event"></th>
					<th data-i18n="settings.systemEventLog.table.device"></th>
					<th data-i18n="settings.systemEventLog.table.tagOrCode"></th>
					<th data-i18n="settings.systemEventLog.table.person"></th>
				</tr>
			</thead>
			<tbody id="systemEventLogBody">
			</tbody>
		</table>
    </fieldset>
	<br /><br />

	<script type="text/javascript">

        function onHomeyReady()
		{
			// Retrieve log file			
        	Homey.get('systemEventLog', function(err, eventLog){
        		if(err)
        		{
        			console.log("Can't retrieve event log.");
        			return console.error(err);
        		}
        		
				if(typeof eventLog === 'undefined' || eventLog === null || eventLog.length <= 0)
				{
					document.getElementById('systemEventLogBody').innerHTML = '<tr><td colspan="5">' + __('settings.systemEventLog.messages.noEventsYet') + '</td></tr>';
					return;
				}
				
				// Parse array into log table
				var previousChild = null;
				for (var i = 0; i < eventLog.length; i++)
				{
					var logEntry = eventLog[i];
					var tableRow = document.createElement("tr");
					
					console.log(logEntry);
					
					// Parse data in nice format
					var date = new Date(logEntry.time);
					var device = logEntry.deviceName === null ? (logEntry.deviceId !== null ? logEntry.deviceId : __('settings.systemEventLog.messages.deviceUnknown')) : logEntry.deviceName;
					var user = logEntry.userName === null ? __('settings.systemEventLog.messages.userNameUnknown') : logEntry.userName + '(' + logEntry.userId + ')';
										
					tableRow.innerHTML += '<td>' + date.toString() + '</td>';
					tableRow.innerHTML += '<td>' + __('settings.systemEventLog.eventTypes.s' + logEntry.statusCode) + '</td>';
					tableRow.innerHTML += '<td>' + device + '</td>';
					tableRow.innerHTML += '<td>' + logEntry.tagId + '</td>';
					tableRow.innerHTML += '<td>' + user + '</td>';
					
					var tableBody = document.getElementById('systemEventLogBody');
					if(previousChild === null)
					{
						tableBody.appendChild(tableRow);
						previousChild = tableBody.getElementsByTagName("tr")[0];
					}
					else
					{
						previousChild = tableBody.insertBefore(tableRow, previousChild);
					}
				}
        	});
			
			Homey.get('userContainer', function (err, users)
			{
				if(err)
        		{
        			console.log("Can't retrieve event log.");
        			return console.error(err);
        		}
        		
				if(typeof users === 'undefined' || users === null || users.length <= 0)
				{
					//document.getElementById('systemEventLogBody').innerHTML = '<tr><td colspan="5">' + __('settings.systemEventLog.messages.noUsersFound') + '</td></tr>';
					return;
				}
				
				for (var i = 0; i < users.length; i++)
				{
					var userEntry = users[i];
					var tableRow = document.createElement("tr");
					
					console.log(userEntry);
															
					tableRow.innerHTML += '<td>' + userEntry.id + '</td>';
					tableRow.innerHTML += '<td>' + userEntry.name + '</td>';
					tableRow.innerHTML += '<td>Not supported yet</td>';
					tableRow.innerHTML += '<td>' + __('settings.systemEventLog.eventTypes.s' + userEntry.statusCode) + '</td>';
					
					var tableBody = document.getElementById('systemUserLogBody');
					tableBody.appendChild(tableRow);
				}
			});
						
			Homey.ready();
		}
		
	</script>
	<body>
</html>